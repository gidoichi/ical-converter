name: Generate README.md
on:
  push:
    branches: ["**"]
jobs:
  checkout:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          path: ${{ github.workspace }}
          name: checkout
          include-hidden-files: true

  generate:
    needs: checkout
    runs-on: ubuntu-latest
    container:
      image: gidoichi/r-rmd:v4.5.0-xpectr@sha256:a6399d06e38f05b22512ba4446c8002fe99bb44907524c0c265313282367352a
    steps:
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          name: checkout
      - uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6
        with:
          go-version-file: go.mod
      - name: Build binary
        run: go build
      - name: Generate README.md
        run: R -q -e 'knitr::knit("README.Rmd")'
      - name: Remove binary
        run: rm ./ical-converter
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          path: ${{ github.workspace }}
          name: generate
          include-hidden-files: true

  no-diff:
    needs: generate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          name: generate
      - run: git diff --exit-code --color

  pull-request:
    needs: no-diff
    if: ${{ failure() && needs.no-diff.result == 'failure' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          name: generate
      - uses: peter-evans/create-pull-request@98357b18bf14b5342f975ff684046ec3b2a07725 # v8
        with:
          branch: create-pull-request/patch/gendocs
          commit-message: "[skip ci] [create-pull-request] automated change"
          delete-branch: true
          token: ${{ secrets.GH_PAT_FOR_CREATE_PULL_REQUEST_ACTION }}
